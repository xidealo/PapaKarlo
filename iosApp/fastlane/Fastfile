default_platform(:ios)

platform :ios do
  before_all do
    # Выбираем версию Xcode для сборки
    xcodes(version: "16.4", select_for_current_build_only: true)

    # App Store Connect API Key
    app_store_connect_api_key(
      key_id: ENV['APP_STORE_KEY_ID'],
      issuer_id: ENV['APP_STORE_ISSUER_ID'],
      key_filepath: ENV['APP_STORE_P8_PATH']
    )
  end

  # Список приложений с идентификатором и схемой
  apps = {
     papakarlo:    { id: "com.bunbeauty.papakarlo", scheme: "papakarlo" },
     gustopub:     { id: "com.bunbeauty.gustopub", scheme: "gustoPub" },
     yuliar:       { id: "com.bunbeauty.yuliar", scheme: "yuliar" },
     tandirhouse:  { id: "com.bunbeauty.tandirhouse", scheme: "tandirhouse" },
     vkuskavkaza:  { id: "com.bunbeauty.vkuskavkaza", scheme: "vkuskavkaza" },
     djan:         { id: "com.bunbeauty.djan", scheme: "djan" },
     usaba:        { id: "com.bunbeauty.usadba", scheme: "usadba" },
     emoji:        { id: "com.bunbeauty.emoji", scheme: "emoji" },
     estpoest:     { id: "com.bunbeauty.estpoest", scheme: "estpoest" },
     taverna:      { id: "com.bunbeauty.taverna", scheme: "taverna" },
     voljane:      { id: "com.bunbeauty.voljane", scheme: "voljane" }
  }

  # Универсальная функция сборки и заливки
  def build_and_upload(app_identifier, scheme)
    build_app(scheme: scheme)
    upload_to_testflight
  end

  # Динамическая генерация lane для каждого приложения
  apps.each do |lane_name, config|
    desc "Push a new #{lane_name} release build to the App Store"
    lane lane_name do
      build_and_upload(config[:id], config[:scheme])
    end
  end

  # Lane для деплоя всех приложений
  desc "Deploy all apps to TestFlight"
  lane :deployAll do
    apps.keys.each do |app|
      begin
        send(app)
      rescue => e
        UI.error("Failed to deploy #{app}: #{e.message}")
      end
    end
  end
end
